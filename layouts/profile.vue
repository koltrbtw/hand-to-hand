<template>
    <div class="platformads">
        <SiteHeader />
        <div v-if="isLoaded && profile">
            <div class="main">
                <div class="profiles">
                    <div class="profilespanel">
                        <h1>Профиль</h1>
                        <h2>{{ isSelf ? 'Вы' : 'Пользователь' }}</h2>
                        <div class="user">
                            <div class="userinfo">
                                <div class="username">
                                    <a>{{ profile.firstName }} {{ profile.lastName }}</a>
                                </div>
                                <div class="userrating">
                                    <p>Рейтинг: {{ rating !== null ? rating.toFixed(1) : '—' }}</p>
                                    <p>Регистрация: {{ formatDate(profile.createdAt) }}</p>
                                </div>
                            </div>
                            <div class="useravatar">
                                <img :src="profile.avatarUrl || '/img/user.png'" />
                            </div>
                        </div>

                        <div class="line"></div>

                        <div class="listpage">
                            <NuxtLink
                                v-if="isSelf"
                                to="/profile/edit"
                                class="blockpage"
                                :class="{ active: $route.path === '/profile/edit' }"
                            >
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10.5731 6.59155L11.8715 7.57746C12.0061 7.69014 12.035 7.8216 11.958 7.97183L10.7174 10.0563C10.6404 10.2066 10.5154 10.2441 10.3423 10.169L8.81312 9.57747C8.46689 9.8216 8.12066 10.0188 7.77443 10.169L7.54361 11.7465C7.52437 11.9155 7.41858 12 7.22623 12H4.77377C4.60066 12 4.49486 11.9155 4.45639 11.7465L4.22557 10.169C3.86011 10.0188 3.51388 9.8216 3.18689 9.57747L1.6577 10.169C1.48459 10.2254 1.35956 10.1878 1.28262 10.0563L0.0419672 7.97183C-0.0349727 7.8216 -0.00612021 7.69014 0.128525 7.57746L1.42689 6.59155C1.40765 6.3662 1.39803 6.16901 1.39803 6C1.39803 5.83099 1.40765 5.6338 1.42689 5.40845L0.128525 4.42253C-0.00612021 4.30986 -0.0349727 4.1784 0.0419672 4.02817L1.28262 1.94366C1.3788 1.79343 1.50383 1.75587 1.6577 1.83099L3.18689 2.42254C3.53311 2.1784 3.87934 1.98122 4.22557 1.83099L4.45639 0.253521C4.49486 0.084507 4.60066 0 4.77377 0H7.22623C7.41858 0 7.52437 0.084507 7.54361 0.253521L7.77443 1.83099C8.13989 1.98122 8.48612 2.1784 8.81312 2.42254L10.3423 1.83099C10.5154 1.77465 10.6404 1.81221 10.7174 1.94366L11.958 4.02817C12.035 4.1784 12.0061 4.30986 11.8715 4.42253L10.5731 5.40845C10.6116 5.6338 10.6308 5.83099 10.6308 6C10.6308 6.16901 10.6116 6.3662 10.5731 6.59155ZM6 8.11268C6.58667 8.11268 7.09159 7.9061 7.51475 7.49296C7.93792 7.07981 8.14951 6.58216 8.14951 6C8.14951 5.41784 7.93792 4.92019 7.51475 4.50704C7.09159 4.0939 6.58667 3.88732 6 3.88732C5.41333 3.88732 4.90842 4.0939 4.48525 4.50704C4.06208 4.92019 3.85049 5.41784 3.85049 6C3.85049 6.58216 4.06208 7.07981 4.48525 7.49296C4.90842 7.9061 5.41333 8.11268 6 8.11268Z"/>
                                </svg>
                                <p>Управление</p>
                            </NuxtLink>

                            <NuxtLink
                                :to="`/profile/announcement${isSelf ? '' : '?id=' + profile.id}`"
                                class="blockpage"
                                :class="{ active: $route.path === '/profile/announcement' }"
                            >
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_50_7)">
                                        <path d="M8.25 7.875H10.9012C10.7866 8.07559 10.6453 8.25976 10.4813 8.4225L8.4225 10.4813C8.25976 10.6453 8.07559 10.7866 7.875 10.9012V8.25C7.875 8.15054 7.91451 8.05516 7.98483 7.98483C8.05516 7.91451 8.15054 7.875 8.25 7.875Z"/>
                                        <path d="M11.25 1.875V6.56625C11.2509 6.75415 11.2307 6.94156 11.19 7.125H8.25C7.95191 7.12589 7.66627 7.2447 7.45549 7.45549C7.2447 7.66627 7.12589 7.95191 7.125 8.25V11.19C6.94156 11.2307 6.75415 11.2509 6.56625 11.25H1.875C1.57691 11.2491 1.29127 11.1303 1.08049 10.9195C0.869703 10.7087 0.75089 10.4231 0.75 10.125V1.875C0.75089 1.57691 0.869703 1.29127 1.08049 1.08049C1.29127 0.869703 1.57691 0.75089 1.875 0.75H10.125C10.4231 0.75089 10.7087 0.869703 10.9195 1.08049C11.1303 1.29127 11.2491 1.57691 11.25 1.875Z"/>
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_50_7">
                                            <rect width="12" height="12" fill="white"/>
                                        </clipPath>
                                    </defs>
                                </svg>
                                <p>Объявления</p>
                            </NuxtLink>

                            <NuxtLink
                                :to="`/profile/feedback${isSelf ? '' : '?id=' + profile.id}`"
                                class="blockpage"
                                :class="{ active: $route.path === '/profile/feedback' }"
                            >
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11.4545 1.11534e-05H7.63636C7.32408 -0.00126533 7.02129 0.107063 6.78098 0.306041C6.54066 0.505019 6.37813 0.781974 6.32182 1.08844L5.82 3.83674C5.78532 4.02821 5.79323 4.22496 5.84319 4.41304C5.89315 4.60113 5.98392 4.77596 6.10909 4.92517C6.23495 5.07446 6.39187 5.19462 6.56895 5.27732C6.74603 5.36002 6.93903 5.40328 7.13455 5.40408H8.72727L8.59091 5.76327C8.49024 6.02959 8.45527 6.31617 8.48896 6.59882C8.52264 6.88147 8.624 7.15188 8.78446 7.38722C8.94492 7.62256 9.15978 7.81593 9.4109 7.951C9.66202 8.08607 9.94202 8.15887 10.2273 8.16326C10.3331 8.1641 10.4369 8.13418 10.526 8.07717C10.6151 8.02015 10.6857 7.9385 10.7291 7.84217L11.9509 5.08844C11.9787 5.02845 11.9954 4.9639 12 4.89796V0.544228C12 0.399893 11.9425 0.261469 11.8402 0.159409C11.7379 0.0573481 11.5992 1.11534e-05 11.4545 1.11534e-05ZM10.9091 4.75102L9.91091 6.99864C9.81349 6.94575 9.72952 6.87128 9.66545 6.78095C9.60126 6.69029 9.56068 6.58513 9.54735 6.47493C9.53402 6.36473 9.54836 6.25295 9.58909 6.14966L9.79636 5.60544C9.85089 5.4643 9.86947 5.31186 9.85043 5.16179C9.83139 5.01173 9.77533 4.86872 9.68727 4.74558C9.60056 4.62292 9.48522 4.52315 9.35124 4.45488C9.21725 4.38662 9.06862 4.35191 8.91818 4.35374H7.12364C7.0874 4.35385 7.05157 4.34611 7.01862 4.33108C6.98566 4.31605 6.95636 4.29408 6.93273 4.26667C6.89039 4.20864 6.87274 4.13626 6.88364 4.06531L7.38545 1.34423C7.38311 1.3105 7.38794 1.27665 7.39965 1.24493C7.41135 1.2132 7.42965 1.1843 7.45336 1.16014C7.47706 1.13597 7.50562 1.11709 7.53716 1.10473C7.56871 1.09238 7.60252 1.08683 7.63636 1.08844H10.9091V4.75102ZM4.87636 6.55782H3.3L3.43636 6.19864C3.53558 5.93076 3.56852 5.64294 3.53237 5.35964C3.49623 5.07634 3.39207 4.80593 3.22875 4.57139C3.06544 4.33685 2.84778 4.14512 2.59429 4.01248C2.3408 3.87984 2.05896 3.81022 1.77273 3.80953C1.66688 3.80869 1.56307 3.83861 1.47396 3.89562C1.38486 3.95264 1.31431 4.03429 1.27091 4.13062L0.0490909 6.88435C0.0178338 6.95275 0.0011189 7.02687 0 7.10204V11.4558C0 11.6001 0.0574673 11.7385 0.15976 11.8406C0.262052 11.9427 0.400791 12 0.545455 12H4.36364C4.67592 12.0013 4.97871 11.8929 5.21902 11.694C5.45934 11.495 5.62187 11.218 5.67818 10.9116L6.18 8.19047C6.21468 7.999 6.20677 7.80225 6.15681 7.61417C6.10685 7.42608 6.01608 7.25125 5.89091 7.10204C5.77264 6.94214 5.6203 6.8104 5.44487 6.7163C5.26944 6.62219 5.07528 6.56807 4.87636 6.55782ZM4.61455 10.683C4.60518 10.7416 4.57432 10.7947 4.52796 10.8319C4.4816 10.8691 4.42304 10.8878 4.36364 10.8843H1.09091V7.22177L2.08909 4.97415C2.18651 5.02704 2.27048 5.10151 2.33455 5.19184C2.39874 5.2825 2.43932 5.38766 2.45265 5.49786C2.46598 5.60806 2.45164 5.71984 2.41091 5.82313L2.20364 6.36735C2.14911 6.50849 2.13053 6.66093 2.14957 6.81099C2.16861 6.96106 2.22467 7.10407 2.31273 7.22721C2.39823 7.35188 2.51302 7.45377 2.64709 7.52397C2.78116 7.59417 2.93041 7.63055 3.08182 7.62993H4.87636C4.9126 7.62983 4.94843 7.63756 4.98138 7.65259C5.01434 7.66762 5.04364 7.6896 5.06727 7.717C5.10962 7.77504 5.12726 7.84741 5.11636 7.91836L4.61455 10.683Z"/>
                                </svg>
                                <p>Отзывы</p>
                            </NuxtLink>

                            <NuxtLink
                                v-if="isSelf"
                                to="/profile/dialog"
                                class="blockpage"
                                :class="{ active: $route.path === '/profile/dialog' }"
                            >
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4.63195 0C2.10615 0 0 1.87561 0 4.25139C0 5.46679 0.61605 6.52613 1.49103 7.29939C1.43453 7.71025 1.27983 8.09813 1.04219 8.42475C0.945208 8.5588 0.843859 8.68909 0.738333 8.81538C0.683708 8.87754 0.635127 8.94559 0.593353 9.01845C0.566951 9.06496 0.525727 9.11698 0.506736 9.22201C0.487281 9.32655 0.513684 9.4986 0.593353 9.62815L0.651253 9.73768L0.767051 9.8002C1.17235 10.0188 1.61007 9.98026 2.01212 9.86272C2.41371 9.74469 2.80002 9.54262 3.17011 9.33105C3.53974 9.11998 3.8913 8.89891 4.16876 8.73736C4.20767 8.71485 4.23268 8.70935 4.2702 8.69034C5.00066 9.7747 6.33836 10.5034 7.83078 10.5034C7.84514 10.5054 7.85857 10.5034 7.87432 10.5034C8.47647 10.5034 10.4219 12.6511 11.5799 11.8009C11.6262 11.6013 10.5618 11.1006 10.5085 9.61264C11.415 8.92092 12 7.89208 12 6.75221C12 5.06566 10.7605 3.6722 9.10503 3.17304C8.58116 1.33244 6.75987 0 4.63195 0ZM4.63195 1.00033C6.7381 1.00033 8.33751 2.52583 8.33751 4.25139C8.33751 5.97695 6.7381 7.50245 4.63195 7.50245C4.25584 7.50245 4.03999 7.66851 3.73428 7.84656C3.42857 8.02412 3.07793 8.24469 2.73563 8.44026C2.43919 8.60931 2.15664 8.73936 1.89632 8.83089C2.14969 8.43576 2.41417 7.91609 2.46049 7.18985L2.47532 6.90826L2.25808 6.7367C1.43266 6.112 0.926391 5.2132 0.926391 4.25139C0.926391 2.52583 2.5258 1.00033 4.63195 1.00033Z"/>
                                </svg>
                                <p>Сообщения</p>
                            </NuxtLink>

                            <a v-if="isSelf" class="blockpage" @click="logout">
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_51_13)">
                                        <path d="M7.75001 9H7.25002C7.11195 9 7.00001 9.11194 7.00001 9.25001V11H1.00001V1.00001H7.00001V2.75002C7.00001 2.88809 7.11195 3.00002 7.25002 3.00002H7.75001C7.88808 3.00002 8.00002 2.88809 8.00002 2.75002V1.00001C7.99999 0.447727 7.55229 0 7.00001 0H1.00001C0.447727 0 0 0.447727 0 1.00001V11C0 11.5523 0.447727 12 1.00001 12H7.00001C7.55229 12 8.00002 11.5523 8.00002 11V9.24998C7.99999 9.11194 7.88808 9 7.75001 9Z"/>
                                        <path d="M11.919 5.81569L8.91895 3.0657C8.84571 2.99904 8.73952 2.98074 8.64942 3.02126C8.60499 3.04075 8.56719 3.07277 8.54066 3.11339C8.51412 3.15402 8.5 3.20149 8.50001 3.25001V3.75003C8.50001 3.82083 8.53003 3.88845 8.58277 3.93582L10.3207 5.50004H3.25001C3.21717 5.50001 3.18465 5.50647 3.15431 5.51902C3.12397 5.53158 3.0964 5.54999 3.07318 5.57321C3.04996 5.59643 3.03154 5.624 3.01899 5.65434C3.00643 5.68469 2.99998 5.71721 3 5.75004V6.25004C2.99998 6.28287 3.00643 6.31539 3.01899 6.34574C3.03154 6.37608 3.04996 6.40365 3.07318 6.42687C3.0964 6.45009 3.12397 6.4685 3.15431 6.48106C3.18465 6.49361 3.21717 6.50007 3.25001 6.50004H10.3207L8.58277 8.06426C8.55671 8.08769 8.53588 8.11634 8.52162 8.14835C8.50736 8.18036 8.5 8.21501 8.50001 8.25005V8.75004C8.50001 8.84916 8.5586 8.93902 8.64942 8.97879C8.68165 8.99321 8.71608 9.00003 8.75002 9.00003C8.81131 9.00003 8.87184 8.97732 8.91895 8.93436L11.919 6.18436C11.9707 6.137 12 6.07011 12 6.00003C12 5.92995 11.9707 5.86306 11.919 5.81569Z"/>
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_51_13">
                                            <rect width="12" height="12" fill="white"/>
                                        </clipPath>
                                    </defs>
                                </svg>
                                <p>Выйти</p>
                            </a>
                        </div>

                    </div>
                    <slot />

                </div>
            </div>
        </div>
        <div v-else class="loading">Загрузка профиля...</div>
        <SiteFooter />
    </div>
</template>

<script setup>
import SiteHeader from '~/components/SiteHeader.vue'
import SiteFooter from '~/components/SiteFooter.vue'

const route = useRoute()
const router = useRouter()
const { $api } = useNuxtApp()
const userStore = useUserStore()

const user = computed(() => userStore.user)
const id = computed(() => {
    const queryId = Number(route.query.id)
    const localId = userStore.user?.id

    if (Number.isFinite(queryId)) return queryId
    if (Number.isFinite(localId)) return localId

    return null
})

const isSelf = computed(() => user.value?.id === id.value)

const profile = ref(null)
const rating = ref(null)
const isLoaded = ref(false)

onMounted(async () => {
    await userStore.fetchUser()

    if (!id.value) return router.push('/')

    try {
        const res = await $api(`/account/profile?id=${id.value}`)
        profile.value = res.user

        const feedback = await $api(`/feedback/user?id=${id.value}`)
        rating.value = feedback.average

        isLoaded.value = true
    } catch (err) {
        console.error('Ошибка профиля:', err)
        router.push('/')
    }
})

function formatDate(date) {
    return new Date(date).toLocaleDateString('ru-RU')
}

function logout() {
    useCookie('token').value = null
    userStore.user = null
    router.push('/')
}
</script>

